const matchThreshold=.75,defaultDisplayedFang=5,nonHanziRegex=/[^\u4e00-\u9fa5䗪]+/g;function analyze(){let a=$("#usage_wrapper"),e=$("#warning_message"),n=$("#info_message"),r=$("#jinsifang_wrapper"),t=$("#yaodui_wrapper"),s=$("#wuwei_wrapper"),h=$("#siqi_wrapper"),l=$("#shengjiang_wrapper"),p=$("#guijing_wrapper"),o=$("#search_input"),g=$("#current_search_input");if(""==o.val().trim()){g.val(""),a.hide(),e.empty(),n.empty(),r.empty(),t.empty(),s.empty(),h.empty(),l.empty(),p.empty();return}let c=o.val().replace(nonHanziRegex,",").split(",");if(c.length>20){e.empty(),e.append(`<div>药味数太多，最多允许20</div>`);return}let d="",f="";if(1==c.length){let m=c[0].indexOf("出自"),u=m>0?fangDict.find(a=>a.name==c[0].substring(0,m)&&a.src.replace(nonHanziRegex,"")==c[0].substring(m+2)):fangDict.find(a=>a.name==c[0]);!u&&(fangAliasObj=fangAliasDict.find(a=>a.alias==c[0]))&&(u=fangDict.find(a=>a.name==fangAliasObj.fang)),u&&(d=u.name,f=m>0?c[0].substring(m+2):"",c=u.arr.map(a=>a.yao))}let y=[],v=[],j=[],b=[],z=[],w=[{name:"酸",arr:[]},{name:"微酸",arr:[]},{name:"苦",arr:[]},{name:"微苦",arr:[]},{name:"甘",arr:[]},{name:"微甘",arr:[]},{name:"辛",arr:[]},{name:"微辛",arr:[]},{name:"咸",arr:[]},{name:"淡",arr:[]},{name:"涩",arr:[]}],x=[{name:"大寒",arr:[]},{name:"寒",arr:[]},{name:"微寒",arr:[]},{name:"凉",arr:[]},{name:"平",arr:[]},{name:"微温",arr:[]},{name:"温",arr:[]},{name:"热",arr:[]},{name:"大热",arr:[]}],C=[{name:"升浮",arr:[]},{name:"沉降",arr:[]},{name:"双重趋向",arr:[]}],k=[];if(c.forEach(a=>{if(v.indexOf(a)>=0)return!0;let e=yaoDict.find(e=>e.name==a);if(!e){let n=yaoAliasDict.find(e=>e.alias==a);if(!n)return a&&0>y.indexOf(a.substring(0,9))&&y.push(a.substring(0,9)),!0;a=n.yao,e=yaoDict.find(e=>e.name==a),0>j.indexOf(n.alias)&&j.push(n)}v.push(a),e.wuwei.forEach(e=>{let n=w.find(a=>a.name==e);n?n.arr.push(a):w.push({name:e,arr:[a]})});let r=x.find(a=>a.name==e.siqi);r?r.arr.push(a):x.push({name:e.siqi,arr:[a]});let t=C.find(a=>a.name==e.shengjiang);t?t.arr.push(a):C.push({name:e.shengjiang,arr:[a]}),e.guijing.forEach(e=>{let n=k.find(a=>a.name==e);n?n.arr.push(a):k.push({name:e,arr:[a]})})}),o.val(v.join(" ")),d?g.val(d+(f?"出自"+f:"")):g.val(v.join(" ")),fangDict.forEach(a=>{let e=a.arr.filter(a=>"j"==a.jczs).length;if(v.length<(a.arr.length+e)*.75-e)return!0;let n=Math.floor(precisionRound((a.arr.length+e)*.25,1)),r=0,t=0,s=[];a.arr.forEach(a=>{let e=v.indexOf(a.yao)>=0;if(e)t+="j"==a.jczs?2:1;else if(++r>n)return!0;s.push({yao:a.yao,pz:a.pz,yl:a.yl,jczs:a.jczs,isMatched:e})});let h=precisionRound(t/(a.arr.length+e),2);h>=.75&&b.push({name:a.name,source:a.src,yf:a.yf,zz:a.zz,bj:a.bj,percentage:h,arr:s})}),yaoduiDict.forEach(a=>{a.arr.every(a=>v.indexOf(a)>=0)&&z.push({arr:a.arr,gx:a.gx,cf:a.cf,pri:a.pri})}),a.hide(),e.empty(),n.empty(),r.empty(),t.empty(),s.empty(),h.empty(),l.empty(),p.empty(),y.length>0&&(e.append(`<span>未知药${1==y.length&&0==v.length?"或方":""}: ${y.join("、")}</span>`),e.append("<br/>")),j.length>0&&(e.append(`<span>非规范药名(已更正): ${j.map(a=>a.alias+"→"+a.yao).join("、")}</span>`),e.append("<br/>")),d){n.append(`<span>查方: </span><span id="search_fang_name">${d}</span>`);let Y=fangWithSameNameDict.find(a=>a.fang==d);Y&&(n.append(`<span>，此方有不同配伍版本</span>`),Y.srcArr.forEach(a=>{n.append(`<br/><span class="fangming" onclick="triggerFangSearch('${Y.fang}出自${a.replace(nonHanziRegex,"")}')">${a}<span>`)})),n.append("<br/>")}else v.length>0&&n.append(`<span>组方，共${v.length}味</span>`);if(b.length>0){b.sort((a,e)=>1==a.percentage&&a.name==d?-1:1==e.percentage&&e.name==d?1:a.percentage>e.percentage?-1:a.percentage<e.percentage?1:a.arr.length>e.arr.length?-1:0);for(let _=0;_<b.length;_++){let E=b[_];r.append(`<div class="fang-inner-wrapper ${_>=5?"hidden":""}" data-sequence="${_}"></div>`);let O=r.children().last();O.append(`<span class="fangming" onclick="triggerSearch(this)">${E.name}</span><span> ${0>E.source.indexOf("《")?"《":""}${E.source}${0>E.source.indexOf("《")?"》":""} ${Math.round(100*E.percentage)}%</span>`);let A=fangInnerDict.find(a=>a.fang==E.name),R=[],S="",H="",I="";A&&A.arr.forEach(a=>a.arr.forEach(a=>R.push({yao:a,isMatched:!1}))),E.arr.forEach(a=>{let e=R.find(e=>e.yao==a.yao);e?e.isMatched=a.isMatched:H+=`<span class="yao ${a.isMatched?"highlighted":""} ${"j"==a.jczs?"jun":""}">${a.yao}</span><span class="sub">${a.pz}${a.yl}</span>`}),A&&A.arr.forEach(a=>{let e="",n=!0;for(let r=0;r<a.arr.length;r++){let t=R.find(e=>e.yao==a.arr[r]);e+=`<span class="sub ${t.isMatched?"highlighted":""}">${(0==r?"":" ")+t.yao}</span></span>`,n&=t.isMatched}e=`<span class="yao ${n?"highlighted":""}">${a.fang}</span><span class="sub">(</span>`+e,e+=`<span class="sub">)${a.remark}</span>`,"H"==a.pos?S+=e:I+=e}),O.append(S+H+I),E.yf&&O.append(`<br/><span class="sub">[用法] ${E.yf}`),E.zz&&O.append(`<br/><span class="sub">[主治] ${E.zz}`),E.bj&&O.append(`<br/><span class="sub">[病机] ${E.bj}`)}b.length>5&&r.append('<div class="loadmore-wrapper" onclick="loadMoreOrLessFang(this)"><img class="loadmore" src="image/loadmore.svg"></div>')}if(v.length>0&&(0==b.length||b[0].percentage<.75)&&a.html(`仅罗列药味匹配度超过75%的方`).show(),b.length>0&&b[0].percentage>=.8){let M=b[0];z.forEach(a=>{a.cf==M.name&&(a.pri+=10),a.arr.forEach(e=>{for(i=0;i<M.arr.length;i++)e==M.arr[i].yao&&"j"==M.arr[i].jczs&&(a.pri+=3)})})}z.sort((a,e)=>a.pri>e.pri?-1:a.pri<e.pri?1:0),(z=z.slice(0,3)).forEach(a=>{t.append(`<span class="yd" onclick=highlightYaodui(this)>${a.arr.join("+")}--${a.gx}--${a.cf}</span>`),t.append("<br/>")}),w.forEach(a=>{a.arr.length>0&&(s.append(`<span>${a.name}：${a.arr.map(a=>'<span class="yw" onclick=highlightYaoWithSameName(this)>'+a+"</span>").join("、")}`),s.append("<br/>"))}),x.forEach(a=>{a.arr.length>0&&(h.append(`<span>${a.name}</span>：${a.arr.map(a=>'<span class="yw" onclick=highlightYaoWithSameName(this)>'+a+"</span>").join("、")}`),h.append("<br/>"))}),C.forEach(a=>{"平"!=a.name&&a.arr.length>0&&(l.append(`<span>${a.name}：${a.arr.map(a=>'<span class="yw" onclick=highlightYaoWithSameName(this)>'+a+"</span>").join("、")}`),l.append("<br/>"))}),k.forEach(a=>{p.append(`<span>${a.name}：${a.arr.map(a=>'<span class="yw" onclick=highlightYaoWithSameName(this)>'+a+"</span>").join("、")}`),p.append("<br/>")})}function triggerFangSearch(a){$("#search_input").val(a),analyze()}function triggerSearch(a){$("#search_input").val($(a).text()),analyze()}function highlightYaodui(a){let e=$(a).html(),n=e.split("--")[0].split("+"),r=$(a).hasClass("highlighted");$("#yaodui_wrapper .yd").each(function(){$(this).html()==e?$(this).toggleClass("highlighted"):$(this).removeClass("highlighted")}),$("#yao_details .yw").each(function(){n.indexOf($(this).html())>=0?r?$(this).removeClass("highlighted"):$(this).addClass("highlighted"):$(this).removeClass("highlighted")})}function highlightYaoWithSameName(a){let e=$(a).html();$("#yao_details .yw").each(function(){$(this).html()==e?$(this).toggleClass("highlighted"):$(this).removeClass("highlighted")}),$("#yaodui_wrapper .yd").each(function(){$(this).removeClass("highlighted")})}function getHighlightedYaoArr(){let a=[];return $("#yao_details .yw").each(function(){$(this).hasClass("highlighted")&&0>a.indexOf($(this).html())&&a.push($(this).html())}),a}function highlightYaoByYaoArr(a){a&&0!=a.length&&($("#yao_details .yw").each(function(){a.indexOf($(this).html())>=0?$(this).addClass("highlighted"):$(this).removeClass("highlighted")}),$("#yaodui_wrapper .yd").each(function(){$(this).html().split("--")[0].split("+").every(e=>a.indexOf(e)>=0)?$(this).addClass("highlighted"):$(this).removeClass("highlighted")}))}function loadMoreOrLessFang(a){let e=$(a).children("img");$(".fang-inner-wrapper").each(function(){+$(this).data("sequence")>=5&&(e.hasClass("flip")?$(this).addClass("hidden"):$(this).removeClass("hidden"))}),e.toggleClass("flip")}function getYaoInputArr(){return $("#search_input").val().replace(nonHanziRegex,",").split(",")}function getRandomInt(a){return Math.floor(Math.random()*a)}function precisionRound(a,e){let n=Math.pow(10,e);return Math.round(a*n)/n}function createCookie(a,e,n){let r="";if(n){let t=new Date;t.setTime(t.getTime()+864e5*n),r="; expires="+t.toUTCString()}document.cookie=a+"="+e+r+"; path=/"}function readCookie(a){let e=a+"=",n=document.cookie.split(";");for(let r=0;r<n.length;r++){let t=n[r];for(;" "==t.charAt(0);)t=t.substring(1,t.length);if(0==t.indexOf(e))return t.substring(e.length,t.length)}return null}function eraseCookie(a){createCookie(a,"",-1)}$(document).ready(()=>{$("#search_input").focus();let a=tipDict[getRandomInt(tipDict.length)];$("#info_message").append(`<i>Tip: ${a}</i></br>`),$("input").keyup(function(a){13==a.keyCode&&analyze()}),$("#shortcut_clear").click(function(){$("#search_input").val(""),analyze(),$("#search_input").focus()}),$("#shortcut_delete").click(function(){let a=getYaoInputArr();a.length>0&&(a.pop(),$("#search_input").val(a.join(" ")),analyze())}),$("#shortcut_select_all").click(function(){highlightYaoByYaoArr(getYaoInputArr())}),$("#shortcut_random_yao").click(function(){let a=frequentlyUsedYaoDict[getRandomInt(frequentlyUsedYaoDict.length)];$("#search_input").val(a),analyze()}),$("#shortcut_random_yaodui").click(function(){let a=getHighlightedYaoArr(),e=a.length>0?yaoduiDict.filter(e=>a.every(a=>e.arr.indexOf(a)>=0)):yaoduiDict;if(0==e.length)return;let n=getRandomInt(e.length),r=e[n],t=getYaoInputArr();t.length==r.arr.length&&t.every(a=>r.arr.indexOf(a)>=0)&&(r=e[n=(n+1)%e.length]),$("#search_input").val(r.arr.join(" ")),analyze(),highlightYaoByYaoArr(a)}),$("#shortcut_random_fang").click(function(){let a=getHighlightedYaoArr(),e=a.length>0?fangDict.filter(e=>a.every(a=>e.arr.map(a=>a.yao).indexOf(a)>=0)):fangDict;if(0==e.length)return;let n=getRandomInt(e.length),r=e[n];$("#search_fang_name").html()==r.name&&(r=e[n=(n+1)%e.length]),$("#search_input").val(r.name),analyze(),highlightYaoByYaoArr(a)})});